#include "voxpch.h"
#include "Voxen/VoxRenderer/VoxRenderer.h"

#include "Voxen/Renderer/ComputeShader.h"
#include "Voxen/Renderer/Texture.h"
#include "Voxen/Renderer/Shader.h"
#include "Voxen/Renderer/VertexArray.h"
#include "Voxen/Renderer/RenderCommand.h"
#include "Voxen/Renderer/ShaderStorageBuffer.h"

#include "Voxen/VoxRenderer/SparseVoxelOctree.h"

#include <glm/gtc/matrix_transform.hpp>
#include <glm/gtc/type_ptr.hpp>

namespace Voxen
{
    struct VoxRendererData
    {
        // Fullscreen quad setup
        Ref<VertexArray> QuadVertexArray;
        Ref<VertexBuffer> QuadVertexBuffer;
        Ref<IndexBuffer> QuadIndexBuffer;

        Ref<ComputeShader> ComputeShader;
        Ref<TextureRW> RWTexture;
        Ref<Shader> FullscreenQuadShader;

        Ref<Texture2D> ScreenTexture;

        Ref<ShaderStorageBuffer> VoxelShapeData;
        Ref<ShaderStorageBuffer> MaterialData;

        EditorCamera Camera;
    };

    static VoxRendererData s_Data;

    void VoxRenderer::Init()
    {
        VOX_PROFILE_FUNCTION();

        // Set up the fullscreen quad vertices and indices
        SetupFullscreenQuad();

        s_Data.RWTexture = TextureRW::Create(1600, 900);
        s_Data.ScreenTexture = Texture2D::Create(1600, 900);

        s_Data.ComputeShader = ComputeShader::Create("Resources/Shaders/Raytrace.glsl");

        // Fullscreen quad shader (for rendering the texture)
        s_Data.FullscreenQuadShader = Shader::Create("Resources/Shaders/FullscreenQuad.glsl");

        uint32_t voxelShapeData[] = { 524296, 8, 524292, 65544, 262152, 131080, 262148, 196616, 524296, 262148, 524292, 327684, 262152, 393220, 262148, 458756, 524290, 524296, 524298, 589832, 524294, 655368, 262146, 720904, 262154, 786440, 262150, 851976, 524290, 917508, 524298, 983044, 524294, 1048580, 262146, 1114116, 262154, 1179652, 262150, 1245188, 131080, 1310728, 655368, 1376264, 131076, 1441800, 655364, 1507336, 393224, 1572872, 393220, 1638408, 131080, 1703940, 655368, 1769476, 131076, 1835012, 655364, 1900548, 393224, 1966084, 393220, 2031620, 131074, 2097160, 131082, 2162696, 655362, 2228232, 655370, 2293768, 131078, 2359304, 655366, 2424840, 393218, 2490376, 393226, 2555912, 393222, 2621440, 393222, 2686984, 131074, 2752516, 131082, 2818052, 655362, 2883588, 655370, 2949124, 131078, 3014660, 655366, 3080196, 393218, 3145732, 393226, 3211268, 393222, 3276804, 393222, 3342348, 524296, 3407874, 524296, 3473418, 524292, 3538946, 524292, 3604490, 262152, 3670018, 262152, 3735562, 262148, 3801090, 262148, 3866634, 524296, 3932166, 524292, 3997702, 262152, 4063238, 262148, 4128774, 524290, 4194306, 524298, 4259842, 524290, 4325386, 524298, 4390922, 524294, 4456450, 524294, 4521994, 262146, 4587522, 262154, 4653058, 262146, 4718602, 262154, 4784138, 262150, 4849666, 262150, 4915210, 524290, 4980742, 524298, 5046278, 6, 5111814, 524294, 5177350, 262146, 5242886, 262154, 5308422, 262150, 5373958, 786438, 5439494, 131080, 5505026, 655368, 5570562, 131080, 5636106, 655368, 5701642, 131076, 5767170, 655364, 5832706, 131076, 5898250, 655364, 5963786, 393224, 6029314, 393224, 6094858, 393220, 6160386, 393220, 6225930, 131080, 6291462, 655368, 6356998, 131076, 6422534, 655364, 6488070, 393216, 6553606, 393224, 6619142, 393220, 6684678, 393228, 6750214, 131078, 6815746, 655366, 6881282, 131078, 6946826, 655366, 7012362, 393218, 7077890, 393226, 7143426, 393218, 7208970, 393226, 7274506, 393222, 7340034, 393222, 7405578, 131074, 7471110, 131082, 7536646, 655362, 7602182, 655370, 7667718, 131078, 7733254, 655366, 7798790, 393218, 7864326, 393226, 7929862, 393222, 7995398, 524289, 8060936, 524297, 8126472, 524293, 8192008, 262145, 8257544, 262153, 8323080, 262149, 8388616, 524289, 8454148, 524297, 8519684, 524293, 8585220, 262145, 8650756, 262153, 8716292, 262149, 8781828, 524291, 8847368, 524299, 8912904, 524295, 8978440, 262147, 9043976, 262155, 9109512, 262151, 9175048, 524291, 9240580, 524299, 9306116, 524295, 9371652, 262147, 9437188, 262155, 9502724, 262151, 9568260, 131081, 9633800, 655369, 9699336, 131077, 9764872, 655365, 9830408, 393217, 9895944, 393225, 9961480, 393221, 10027016, 131081, 10092548, 655369, 10158084, 131077, 10223620, 655365, 10289156, 393217, 10354692, 393225, 10420228, 393221, 10485764, 131075, 10551304, 655363, 10616840, 131079, 10682376, 655367, 10747912, 393219, 10813448, 393227, 10878984, 393223, 10944520, 131075, 11010052, 655363, 11075588, 131079, 11141124, 655367, 11206660, 393219, 11272196, 393227, 11337732, 393223, 11403268, 524297, 11468802, 524297, 11534346, 524293, 11599874, 524293, 11665418, 262153, 11730946, 262153, 11796490, 262149, 11862018, 262149, 11927562, 524289, 11993094, 524297, 12058630, 524293, 12124166, 262145, 12189702, 262153, 12255238, 262149, 12320774, 524291, 12386306, 524291, 12451850, 524295, 12517378, 524295, 12582922, 262147, 12648450, 262147, 12713994, 262151, 12779522, 262151, 12845066, 524291, 12910598, 524299, 12976134, 524295, 13041670, 262147, 13107206, 262155, 13172742, 262151, 13238278, 131077, 13303810, 655365, 13369346, 131077, 13434890, 655365, 13500426, 393225, 13565954, 393225, 13631498, 393221, 13697026, 393221, 13762570, 131081, 13828102, 655369, 13893638, 131077, 13959174, 655365, 14024710, 393217, 14090246, 393225, 14155782, 393221, 14221318, 131079, 14286850, 655367, 14352386, 131079, 14417930, 655367, 14483466, 393219, 14548994, 393219, 14614538, 393223, 14680066, 393223, 14745610, 131075, 14811142, 655363, 14876678, 131079, 14942214, 655367, 15007750, 393219, 15073286, 393227, 15138822, 393223, 15204358, 65544, 15269896, 589832, 15335432, 65540, 15400968, 589828, 15466504, 327688, 15532040, 327684, 15597576, 65544, 15663108, 589832, 15728644, 65540, 15794180, 589828, 15859716, 327688, 15925252, 327684, 15990788, 589826, 16056328, 589834, 16121864, 65542, 16187400, 589830, 16252936, 327682, 16318472, 327690, 16384008, 327686, 16449544, 589826, 16515076, 589834, 16580612, 65542, 16646148, 589830, 16711684, 327682, 1114116, 327690, 1179652, 327686, 1245188, 196616, 1310728, 720904, 1376264, 196612, 1441800, 720900, 1507336, 458760, 1572872, 458756, 1638408, 196616, 1703940, 720904, 1769476, 196612, 1835012, 720900, 1900548, 458760, 1966084, 458756, 2031620, 196610, 2097160, 196618, 2162696, 196614, 2359304, 720902, 2424840, 458754, 2490376, 458762, 2555912, 458758, 2686984, 196610, 2752516, 196618, 2818052, 196614, 3014660, 720902, 3080196, 458754, 3145732, 458762, 3211268, 458758, 3276804, 589832, 5570562, 589832, 5701642, 589828, 5832706, 589828, 5963786, 327688, 6029314, 327688, 6094858, 327684, 6160386, 327684, 6225930, 65544, 6291462, 589832, 6356998, 65540, 6422534, 589828, 6488070, 327688, 6619142, 327684, 6684678, 589830, 6881282, 589830, 7012362, 327682, 7077890, 327690, 7143426, 327682, 7208970, 327690, 7274506, 327686, 7340034, 327686, 7405578, 589826, 7602182, 589834, 7667718, 65542, 7733254, 589830, 7798790, 327682, 7864326, 327690, 7929862, 327686, 7995398, 196616, 5505026, 196616, 5636106, 196612, 5767170, 196612, 5898250, 458760, 6029314, 458760, 6094858, 458756, 6160386, 458756, 6225930, 196616, 6291462, 720904, 6356998, 196612, 6422534, 720900, 6488070, 458760, 6619142, 458756, 6684678, 196614, 6815746, 196614, 6946826, 458754, 7077890, 458762, 7143426, 458754, 7208970, 458762, 7274506, 458758, 7340034, 458758, 7405578, 196610, 7471110, 196618, 7536646, 196614, 7733254, 720902, 7798790, 458754, 7864326, 458762, 7929862, 458758, 7995398, 589833, 16121864, 65541, 16187400, 589829, 16252936, 327681, 16318472, 327689, 16384008, 327685, 16449544, 589833, 16580612, 65541, 16646148, 589829, 16711684, 327681, 10354692, 327689, 15925252, 327685, 15990788, 589827, 16056328, 65543, 16187400, 589831, 16252936, 327683, 16318472, 327691, 16384008, 327687, 16449544, 589827, 16515076, 65543, 16646148, 589831, 16711684, 327683, 11272196, 327691, 11337732, 327687, 11403268, 196617, 9633800, 196613, 9764872, 720901, 9830408, 458753, 9895944, 458761, 9961480, 458757, 10027016, 196617, 10092548, 196613, 10223620, 720901, 10289156, 458753, 10354692, 458761, 10420228, 458757, 10485764, 196611, 10551304, 196615, 10682376, 720903, 10747912, 458755, 10813448, 458763, 10878984, 458759, 10944520, 196611, 11010052, 196615, 11141124, 720903, 11206660, 458755, 11272196, 458763, 11337732, 458759, 11403268, 589833, 11468802, 589833, 11534346, 589829, 13369346, 589829, 13500426, 327689, 13565954, 327689, 13631498, 327685, 13697026, 327685, 13762570, 65545, 13828102, 589825, 11993094, 589833, 13893638, 65541, 13959174, 589829, 14024710, 327681, 14090246, 327689, 14155782, 327685, 14221318, 589827, 12386306, 589827, 12451850, 589831, 14352386, 589831, 14483466, 327683, 14548994, 327683, 14614538, 327687, 14680066, 327687, 14745610, 65539, 14811142, 589827, 14876678, 589835, 12976134, 65543, 14942214, 589831, 15007750, 327683, 15073286, 327691, 15138822, 327687, 15204358, 196617, 11730946, 196617, 11796490, 196613, 13303810, 196613, 13434890, 458761, 13565954, 458761, 13631498, 458757, 13697026, 458757, 13762570, 196609, 12189702, 196617, 13828102, 720905, 13893638, 196613, 13959174, 720901, 14024710, 458753, 14090246, 458761, 14155782, 458757, 14221318, 196611, 12648450, 196611, 12713994, 196615, 14286850, 196615, 14417930, 458755, 14548994, 458755, 14614538, 458759, 14680066, 458759, 14745610, 196611, 14811142, 196619, 13172742, 720899, 14876678, 196615, 14942214, 720903, 15007750, 458755, 15073286, 458763, 15138822, 458759, 15204358, 524296, 3407873, 524296, 9, 524292, 3538945, 524292, 65545, 262152, 3670017, 262152, 131081, 262148, 3801089, 262148, 196617, 524296, 262149, 524292, 327685, 262152, 393221, 262148, 458757, 524290, 4325385, 524298, 4390921, 524294, 4456449, 524294, 4521993, 262146, 4718601, 262154, 4784137, 262150, 4849665, 262150, 4915209, 524290, 4980741, 524298, 5046277, 524294, 5177349, 262146, 5242885, 262154, 5308421, 262150, 5373957, 131080, 5636105, 655368, 5701641, 131076, 5898249, 655364, 5963785, 393224, 6029313, 393224, 6094857, 393220, 6160385, 393220, 6225929, 131080, 6291461, 655368, 6356997, 131076, 6422533, 655364, 6488069, 393224, 6619141, 393220, 6684677, 131078, 6946825, 655366, 7012361, 393218, 7208969, 393226, 7274505, 393222, 7340033, 393222, 7405577, 131074, 7471109, 131082, 7536645, 655362, 7602181, 655370, 7667717, 131078, 7733253, 655366, 7798789, 393218, 7864325, 393226, 7929861, 393222, 7995397, 524296, 3407875, 524296, 3473419, 524292, 3538947, 524292, 3604491, 262152, 3670019, 262152, 3735563, 262148, 3801091, 262148, 3866635, 524296, 3932167, 524292, 3997703, 262152, 4063239, 262148, 4128775, 524290, 4194307, 524298, 4259843, 524294, 4456451, 524294, 4521995, 262146, 4587523, 262154, 4653059, 262150, 4849667, 262150, 4915211, 524290, 4980743, 524298, 5046279, 524294, 5177351, 262146, 5242887, 262154, 5308423, 262150, 5373959, 131080, 5505027, 655368, 5570563, 131076, 5767171, 655364, 5832707, 393224, 6029315, 393224, 6094859, 393220, 6160387, 393220, 6225931, 131080, 6291463, 655368, 6356999, 131076, 6422535, 655364, 6488071, 393224, 6619143, 393220, 6684679, 131078, 6815747, 655366, 6881283, 393218, 7077891, 393226, 7143427, 393222, 7340035, 393222, 7405579, 131074, 7471111, 131082, 7536647, 655362, 7602183, 655370, 7667719, 131078, 7733255, 655366, 7798791, 393218, 7864327, 393226, 7929863, 393222, 7995399, 524297, 11534345, 524293, 11599873, 524293, 11665417, 262153, 11796489, 262149, 11862017, 262149, 11927561, 524289, 11993093, 524297, 12058629, 524293, 12124165, 262145, 12189701, 262153, 12255237, 262149, 12320773, 524291, 12451849, 524295, 12517377, 524295, 12582921, 262147, 12713993, 262151, 12779521, 262151, 12845065, 524291, 12910597, 524299, 12976133, 524295, 13041669, 262147, 13107205, 262155, 13172741, 262151, 13238277, 131081, 9633801, 655369, 9699337, 131077, 13434889, 655365, 13500425, 393225, 13565953, 393217, 9895945, 393225, 13631497, 393221, 13697025, 393221, 13762569, 131081, 13828101, 655369, 13893637, 131077, 13959173, 655365, 14024709, 393217, 14090245, 393225, 14155781, 393221, 14221317, 131075, 10551305, 655363, 10616841, 131079, 14417929, 655367, 14483465, 393219, 14548993, 393219, 14614537, 393227, 10878985, 393223, 14680065, 393223, 14745609, 131075, 14811141, 655363, 14876677, 131079, 14942213, 655367, 15007749, 393219, 15073285, 393227, 15138821, 393223, 15204357, 524297, 11468803, 524293, 11599875, 524293, 11665419, 262153, 11730947, 262149, 11862019, 262149, 11927563, 524289, 11993095, 524297, 12058631, 524293, 12124167, 262145, 12189703, 262153, 12255239, 262149, 12320775, 524291, 12386307, 524295, 12517379, 524295, 12582923, 262147, 12648451, 262151, 12779523, 262151, 12845067, 524291, 12910599, 524299, 12976135, 524295, 13041671, 262147, 13107207, 262155, 13172743, 262151, 13238279, 131081, 10092547, 655369, 10158083, 131077, 13303811, 655365, 13369347, 393217, 10354691, 393225, 13565955, 393225, 13631499, 393221, 13697027, 393221, 13762571, 131081, 13828103, 655369, 13893639, 131077, 13959175, 655365, 14024711, 393217, 14090247, 393225, 14155783, 393221, 14221319, 131075, 11010051, 655363, 11075587, 131079, 14286851, 655367, 14352387, 393219, 14548995, 393227, 11337731, 393219, 14614539, 393223, 14680067, 393223, 14745611, 131075, 14811143, 655363, 14876679, 131079, 14942215, 655367, 15007751, 393219, 15073287, 393227, 15138823, 393223, 15204359, 589832, 15335433, 589828, 15466505, 327688, 6029313, 327688, 15532041, 327684, 6160385, 327684, 15597577, 65544, 15663109, 589832, 15728645, 65540, 15794181, 589828, 15859717, 327688, 15925253, 327684, 15990789, 589826, 16056329, 589834, 16121865, 589830, 6881281, 65542, 16187401, 589830, 16252937, 327682, 16318473, 327690, 16384009, 327686, 7340033, 327686, 16449545, 589826, 16515077, 589834, 16580613, 65542, 16646149, 589830, 16711685, 327682, 7864325, 327690, 7929861, 327686, 7995397, 196616, 5636105, 196612, 5898249, 458760, 6029313, 458760, 6094857, 458756, 6160385, 458756, 6225929, 196616, 6291461, 720904, 6356997, 196612, 6422533, 720900, 6488069, 458760, 6619141, 458756, 6684677, 196610, 2097161, 196618, 2162697, 196614, 6815745, 196614, 6946825, 720902, 7012361, 458754, 7208969, 458762, 7274505, 458758, 7340033, 458758, 7405577, 196610, 7471109, 196618, 7536645, 196614, 7733253, 720902, 7798789, 458754, 7864325, 458762, 7929861, 458758, 7995397, 589832, 15728643, 589828, 15859715, 327688, 15925251, 327688, 6094859, 327684, 15990787, 327684, 6225931, 65544, 15269895, 589832, 15335431, 65540, 15400967, 589828, 15466503, 327688, 15532039, 327684, 15597575, 589826, 16515075, 589834, 16580611, 65542, 16646147, 589830, 16711683, 589830, 7012363, 327682, 7077891, 327690, 7143427, 327686, 7340035, 327686, 7405579, 589826, 16056327, 589834, 16121863, 65542, 16187399, 589830, 16252935, 327682, 16318471, 327690, 16384007, 327686, 16449543, 196616, 5505027, 196612, 5767171, 458760, 6029315, 458760, 6094859, 458756, 6160387, 458756, 6225931, 196616, 6291463, 720904, 6356999, 196612, 6422535, 720900, 6488071, 458760, 6619143, 458756, 6684679, 196610, 4587523, 196618, 4653059, 196614, 6815747, 720902, 6881283, 196614, 6946827, 458754, 7077891, 458762, 7143427, 458758, 7340035, 458758, 7405579, 196610, 7471111, 196618, 7536647, 196614, 7733255, 720902, 7798791, 458754, 7864327, 458762, 7929863, 458758, 7995399, 589833, 16121865, 589829, 13369345, 65541, 16187401, 589829, 16252937, 327689, 13565953, 327681, 16318473, 327689, 16384009, 327685, 13697025, 327685, 16449545, 65545, 15663109, 589825, 16515077, 589833, 16580613, 65541, 16646149, 589829, 16711685, 327681, 14090245, 327689, 15925253, 327685, 15990789, 589827, 16056329, 589831, 14352385, 65543, 16187401, 589831, 16252937, 327683, 14548993, 327683, 16318473, 327691, 16384009, 327687, 14680065, 327687, 16449545, 65539, 14811141, 589827, 16515077, 589835, 16580613, 65543, 16646149, 589831, 16711685, 327683, 15073285, 327691, 15138821, 327687, 15204357, 196617, 9633801, 196613, 13303809, 196613, 13434889, 720901, 13500425, 458761, 13565953, 458753, 9895945, 458761, 13631497, 458757, 13697025, 458757, 13762569, 196609, 12189701, 196617, 13828101, 720905, 13893637, 196613, 13959173, 720901, 14024709, 458753, 14090245, 458761, 14155781, 458757, 14221317, 196611, 10551305, 196615, 14286849, 196615, 14417929, 720903, 14483465, 458755, 14548993, 458755, 14614537, 458763, 10878985, 458759, 14680065, 458759, 14745609, 196611, 14811141, 196619, 13172741, 720899, 14876677, 196615, 14942213, 720903, 15007749, 458755, 15073285, 458763, 15138821, 458759, 15204357, 589833, 11468803, 65541, 13303811, 589829, 13369347, 589829, 13500427, 327681, 10354691, 327689, 13565955, 327689, 13631499, 327685, 13697027, 327685, 13762571, 65545, 13828103, 589825, 11993095, 589833, 13893639, 65541, 13959175, 589829, 14024711, 327681, 14090247, 327689, 14155783, 327685, 14221319, 589827, 12386307, 65543, 14286851, 589831, 14352387, 589831, 14483467, 327683, 14548995, 327691, 11337731, 327683, 14614539, 327687, 14680067, 327687, 14745611, 65539, 14811143, 589827, 14876679, 589835, 12976135, 65543, 14942215, 589831, 15007751, 327683, 15073287, 327691, 15138823, 327687, 15204359, 196617, 11730947, 196613, 13303811, 720901, 13369347, 196613, 13434891, 458753, 10354691, 458761, 13565955, 458761, 13631499, 458757, 13697027, 458757, 13762571, 196609, 12189703, 196617, 13828103, 720905, 13893639, 196613, 13959175, 720901, 14024711, 458753, 14090247, 458761, 14155783, 458757, 14221319, 196611, 12648451, 196615, 14286851, 720903, 14352387, 196615, 14417931, 458755, 14548995, 458763, 11337731, 458755, 14614539, 458759, 14680067, 458759, 14745611, 196611, 14811143, 196619, 13172743, 720899, 14876679, 196615, 14942215, 720903, 15007751, 458755, 15073287, 458763, 15138823, 458759, 15204359 };
        s_Data.VoxelShapeData = ShaderStorageBuffer::Create(voxelShapeData, sizeof(voxelShapeData));
        uint32_t materialData[] = { 2863311360, 0, 1437248000, 0, 2857740800, 0, 1431677440, 0, 2863289600, 0, 1437226240, 0, 2857719040, 0, 1431655680, 0, 715827712, 0, 3567954432, 0, 2141891072, 0, 710257152, 0, 3562383872, 0, 2136320512, 0, 715805952, 0, 3567932672, 0, 2141869312, 0, 710235392, 0, 3562362112, 0, 2136298752, 0, 2854922752, 0, 2866063872, 0, 1428859392, 0, 1440000512, 0, 2860493312, 0, 1434429952, 0, 2854900992, 0, 2866042112, 0, 1428837632, 0, 1439978752, 0, 2860471552, 0, 1434408192, 0, 707439104, 0, 3559565824, 0, 718580224, 0, 3570706944, 0, 2133502464, 0, 2144643584, 0, 713009664, 0, 3565136384, 0, 2139029504, 0, 2139073024, 0, 707417344, 0, 3559544064, 0, 718558464, 0, 3570685184, 0, 2133480704, 0, 2144621824, 0, 712987904, 0, 3565114624, 0, 2139051264, 0, 2139094784, 0, 2863278592, 0, 2863322112, 0, 1437215232, 0, 1437258752, 0, 2857708032, 0, 2857751552, 0, 1431644672, 0, 1431688192, 0, 2863300352, 0, 1437236992, 0, 2857729792, 0, 1431666432, 0, 715794944, 0, 3567921664, 0, 715838464, 0, 3567965184, 0, 2141858304, 0, 2141901824, 0, 710224384, 0, 3562351104, 0, 710267904, 0, 3562394624, 0, 2136287744, 0, 2136331264, 0, 715816704, 0, 3567943424, 0, 2130738944, 0, 2141880064, 0, 710246144, 0, 3562372864, 0, 2136309504, 0, 2147450624, 0, 2854889984, 0, 2866031104, 0, 2854933504, 0, 2866074624, 0, 1428826624, 0, 1439967744, 0, 1428870144, 0, 1440011264, 0, 2860460544, 0, 2860504064, 0, 1434397184, 0, 1434440704, 0, 2854911744, 0, 2866052864, 0, 1428848384, 0, 1439989504, 0, 8355584, 0, 2860482304, 0, 1434418944, 0, 4286545664, 0, 2133469696, 0, 2144610816, 0, 2133513216, 0, 2144654336, 0, 712976896, 0, 3565103616, 0, 713020416, 0, 3565147136, 0, 2139040256, 0, 2139083776, 0, 707428096, 0, 3559554816, 0, 718569216, 0, 3570695936, 0, 2133491456, 0, 2144632576, 0, 712998656, 0, 3565125376, 0, 2139062016, 0, 363506176, 0, 3215632896, 0, 1789569536, 0, 357935616, 0, 3210062336, 0, 1783998976, 0, 363484416, 0, 3215611136, 0, 1789547776, 0, 357913856, 0, 3210040576, 0, 1783977216, 0, 1068149248, 0, 3920275968, 0, 2494212608, 0, 1062578688, 0, 3914705408, 0, 2488642048, 0, 1068127488, 0, 3920254208, 0, 2494190848, 0, 1062556928, 0, 3914683648, 0, 2488620288, 0, 3207244288, 0, 3218385408, 0, 1781180928, 0, 1792322048, 0, 360688128, 0, 3212814848, 0, 1786751488, 0, 3207222528, 0, 3218363648, 0, 1781159168, 0, 1792300288, 0, 360666368, 0, 3212793088, 0, 1786729728, 0, 1059760640, 0, 1070901760, 0, 2485824000, 0, 2496965120, 0, 1065331200, 0, 3917457920, 0, 2491394560, 0, 1059738880, 0, 1070880000, 0, 2485802240, 0, 2496943360, 0, 1065309440, 0, 3917436160, 0, 2491372800, 0, 3215600128, 0, 3215643648, 0, 1789536768, 0, 1789580288, 0, 3210029568, 0, 3210073088, 0, 1783966208, 0, 1784009728, 0, 363495168, 0, 3215621888, 0, 1789558528, 0, 357924608, 0, 3210051328, 0, 1783987968, 0, 1068116480, 0, 1068160000, 0, 2494179840, 0, 2494223360, 0, 1062545920, 0, 1062589440, 0, 2488609280, 0, 2488652800, 0, 1068138240, 0, 3920264960, 0, 2494201600, 0, 1062567680, 0, 3914694400, 0, 2488631040, 0, 1781148160, 0, 1792289280, 0, 1781191680, 0, 1792332800, 0, 3212782080, 0, 3212825600, 0, 1786718720, 0, 1786762240, 0, 3207233280, 0, 3218374400, 0, 1781169920, 0, 1792311040, 0, 360677120, 0, 3212803840, 0, 1786740480, 0, 2485791232, 0, 2496932352, 0, 2485834752, 0, 2496975872, 0, 1065298432, 0, 1065341952, 0, 2491361792, 0, 2491405312, 0, 1059749632, 0, 1070890752, 0, 2485812992, 0, 2496954112, 0, 1065320192, 0, 3917446912, 0, 2491383552, 0, 2853546496, 0, 2864687616, 0, 1427483136, 0, 1438624256, 0, 2859117056, 0, 1433053696, 0, 2853524736, 0, 2864665856, 0, 1427461376, 0, 1438602496, 0, 2859095296, 0, 1433031936, 0, 717203968, 0, 3569330688, 0, 2132126208, 0, 2143267328, 0, 711633408, 0, 3563760128, 0, 2137696768, 0, 717182208, 0, 3569308928, 0, 2132104448, 0, 2143245568, 0 };
        s_Data.MaterialData = ShaderStorageBuffer::Create(materialData, sizeof(materialData));
    }

    void VoxRenderer::Shutdown()
    {
        VOX_PROFILE_FUNCTION();
    }

    void VoxRenderer::OnWindowResize(uint32 width, uint32 height)
    {
        s_Data.RWTexture = TextureRW::Create(width, height);
        s_Data.ScreenTexture = Texture2D::Create(width, height);
    }

    void VoxRenderer::BeginScene(const Camera& camera, const Matrix4& cameraTransform)
    {
    }

    void VoxRenderer::BeginEditorScene(const EditorCamera& camera)
    {
        VOX_PROFILE_FUNCTION();
        s_Data.Camera = camera;
    }

    void VoxRenderer::EndScene()
    {
        VOX_PROFILE_FUNCTION();
    }

    void VoxRenderer::RenderScene(Ref<Scene> scene)
    {
        RenderFullscreenQuad();
    }

    void VoxRenderer::SetupFullscreenQuad()
    {
        // Fullscreen quad vertices (positions, texture coords, and entity ID)
        float fullScreenQuadVertices[] =
        {
            // positions         // texture Coords   // ID
            -1.0f, -1.0f, 0.0f,  0.0f, 0.0f,         -1,  // Bottom Left
             1.0f, -1.0f, 0.0f,  1.0f, 0.0f,         -1,  // Bottom Right
             1.0f,  1.0f, 0.0f,  1.0f, 1.0f,         -1,  // Top Right
            -1.0f,  1.0f, 0.0f,  0.0f, 1.0f,         -1   // Top Left
        };

        uint32 indices[] = { 0, 1, 2, 2, 3, 0 };  // Indices for two triangles forming a quad

        // Create the vertex buffer and vertex array
        s_Data.QuadVertexBuffer = VertexBuffer::Create(fullScreenQuadVertices, sizeof(fullScreenQuadVertices));
        s_Data.QuadVertexBuffer->SetLayout({
            { ShaderDataType::Vector3, "a_Position" },
            { ShaderDataType::Vector2, "a_TexCoords" },
            { ShaderDataType::Int,     "a_EntityID" }
            });

        s_Data.QuadVertexArray = VertexArray::Create();
        s_Data.QuadVertexArray->AddVertexBuffer(s_Data.QuadVertexBuffer);

        // Create the index buffer
        s_Data.QuadIndexBuffer = IndexBuffer::Create(indices, sizeof(indices) / sizeof(uint32));
        s_Data.QuadVertexArray->SetIndexBuffer(s_Data.QuadIndexBuffer);
    }

    void VoxRenderer::RunComputeShader()
    {
        // Bind the compute shader
        s_Data.ComputeShader->Bind();

        // Set the screen size uniform
        s_Data.ComputeShader->SetVector2("u_ScreenSize", { s_Data.RWTexture->GetWidth() , s_Data.RWTexture->GetHeight() });

        // Pass the view-projection matrix and camera position
        s_Data.ComputeShader->SetMat4("u_ViewProjectionMatrix", s_Data.Camera.GetViewProjection());
        s_Data.ComputeShader->SetVector3("u_CameraPosition", s_Data.Camera.GetPosition());

        // Bind the texture as an image for writing
        s_Data.RWTexture->BindImage(0);

        s_Data.VoxelShapeData->Bind(3);
        s_Data.MaterialData->Bind(4);

        // Dispatch the compute shader (assuming 1280x720 texture)
        int dispatchX = static_cast<int>(s_Data.RWTexture->GetWidth() / 16);
        int dispatchY = static_cast<int>(s_Data.RWTexture->GetHeight() / 16);
        s_Data.ComputeShader->Dispatch(dispatchX, dispatchY, 1);

        // Ensure memory is synchronized before rendering
        s_Data.RWTexture->Unbind();
    }

    void VoxRenderer::RenderFullscreenQuad()
    {
        // Run the compute shader to color the texture
        RunComputeShader();

        // Bind the fullscreen quad shader
        s_Data.FullscreenQuadShader->Bind();
        s_Data.FullscreenQuadShader->SetInt("u_Texture", 0);  // Bind texture to texture unit 0

        // Bind the read-write texture as the screen texture
        s_Data.RWTexture->Bind(0);

        // Bind the quad vertex array for rendering
        s_Data.QuadVertexArray->Bind();

        // Render the quad (6 vertices for 2 triangles)
        RenderCommand::DrawIndexed(s_Data.QuadVertexArray, s_Data.QuadIndexBuffer->GetCount());

        // Unbind the shader and texture
        s_Data.FullscreenQuadShader->Unbind();
        s_Data.RWTexture->Unbind();
    }
}